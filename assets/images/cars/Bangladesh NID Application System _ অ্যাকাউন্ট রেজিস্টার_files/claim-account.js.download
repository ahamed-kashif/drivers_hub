$(document).ready(function () {

    var container = $("#container");
    var path = window.contextPath + "/claim-account/partial-views";
    const StatusCode = {SUCCESS: "SUCCESS", ERROR: "ERROR", PENDING: "PENDING"};

    let delayTime = 60000;
    let interValTime = 1000;
    let showCounter;

    container.on("click", "#cancel", function () {
        window.location = window.contextPath;
    });

    container.on("click", "#validate", function () {
        asyncForm.handleWithCare({
            url: window.contextPath + "/claim-account/validate",
            doneCallback: handleSecuredAccount
        });
    });

    container.on("click", "#new-mobile", function () {
        asyncForm.handleWithCare({url: window.contextPath + "/claim-account/change-mobile"});
    });

    container.on("click", "#validate-address", function () {
        asyncForm.handleWithCare();
    });

    container.on("click", "#send-sms", function () {
        asyncForm.handleWithCare({
            templateParams: {
                after: delay
            }
        });
    });

    container.on("click", "#resend-sms", function () {
        asyncForm.handleWithCare({
            url: window.contextPath + "/claim-account/resend-sms",
            templateParams: {
                after: delay
            }
        });
    });

    container.on("click", "#verify-code", function () {
        clearInterval(showCounter);
        setOsDetails();
        asyncForm.handleWithCare({
            url: window.contextPath + "/claim-account/verify-code",
            templateParams: {
                after: afrsStatusCheck
            }
        });
    });

    let afrsStatusCheck = function () {
        let afrsCheckInterval;

        setTimeout(function () {
            afrsCheckInterval = setInterval(function () {
                const afrsCheckUrl = window.contextPath + "/claim-account/afrs-check";
                window.showLoadingEnabled = false;
                asyncForm.handleWithCare({
                    url: afrsCheckUrl
                });
            }, 1000);
        }, 5000);

        setTimeout(function () {
            clearInterval(afrsCheckInterval);
            window.location = window.contextPath + "/?afrs=false";
        }, 1800000);
    };

    container.on("change", "select[name=division]", function () {
        lookupLoader.load({
            path: path,
            resource: "district",
            filter: {divisionId: $(this).val()},
            target: "select[name=district]",
            remove: "select[name=upozila]"
        });
    });

    container.on("change", "select[name=district]", function () {
        lookupLoader.load({
            path: path,
            resource: "upozila",
            filter: {districtId: $(this).val()},
            target: "select[name=upozila]"
        });
    });

    container.on("change", "select[name=perDivision]", function () {
        lookupLoader.load({
            path: path,
            resource: "district",
            filter: {divisionId: $(this).val()},
            target: "select[name=perDistrict]",
            remove: "select[name=perUpozila]"
        });
    });

    container.on("change", "select[name=perDistrict]", function () {
        lookupLoader.load({
            path: path,
            resource: "upozila",
            filter: {districtId: $(this).val()},
            target: "select[name=perUpozila]"
        });
    });

    let handleSecuredAccount = function (jqXHR) {
        if (jqXHR.status === StatusCode.SUCCESS) {
            if (jqXHR.success.data) {
                showModalOfSecuredAccount(jqXHR.success.template);
            } else {
                loadTemplate(jqXHR);
            }
        } else if (jqXHR.status === StatusCode.ERROR) {
            if (jqXHR.error.field) {
                $("*[name=" + jqXHR.error.field + "]").parent().addClass("error");
            }
            $("#error-block").addClass("error").show().find("ul > li").text(jqXHR.error.message);
        }
    };

    let showModalOfSecuredAccount = function (template) {
        $('#secure-account-modal').modal({
            onApprove: function () {
                templateLoader.load({
                    templateName: window.contextPath + template
                });
            },
            onDeny: redirectToHome
        }).modal('setting', 'closable', false).modal('show');
    };

    let loadTemplate = function (jqXHR) {
        if (jqXHR.success.redirect) {
            window.location = window.contextPath + jqXHR.success.redirect;
            return;
        }
        templateLoader.load({
            templateName: window.contextPath + jqXHR.success.template
        });
    };

    let redirectToHome = function () {
        window.location = window.contextPath + "/";
    };

    let delay = function () {
        let counter = delayTime / interValTime;
        let originalMessage = $("#resend-sms").children()[0].nextSibling.textContent;

        $("#resend-sms").prop('disabled', true);
        $("#resend-sms").addClass('button-disabled');

        showCounter = setInterval(function () {
            counter--;
            $("#resend-sms").children()[0].nextSibling.textContent = getMessage(originalMessage, counter);
        }, interValTime);

        setTimeout(function () {
            clearInterval(showCounter);
            if ($("#resend-sms").length > 0) {
                $("#resend-sms").prop('disabled', false);
                $("#resend-sms").removeClass('button-disabled');
                $("#resend-sms").children()[0].nextSibling.textContent = originalMessage;
            }
        }, delayTime);
    };

    function getMessage(originalMessage, counter) {
        let counterString = "";
        let banglaDigits = ["০", "১", "২", "৩", "৪", "৫", "৬", "৭", "৮", "৯"];

        if (originalMessage[0] <= 'A' && originalMessage[0] >= 'Z') {
            if (counter < 10) {
                counterString += banglaDigits[counter];
            } else {
                counterString += banglaDigits[Math.floor(counter / 10)] + banglaDigits[counter % 10];
            }
        } else {
            counterString = counter;
        }
        return originalMessage + " (" + counterString + ")";
    }

    function getMobileOperatingSystem() {
        let userAgent = navigator.userAgent || navigator.vendor || window.opera;

        // Windows Phone must come first because its UA also contains "Android"
        if (/windows phone/i.test(userAgent)) {
            return "unknown";
        }

        if (/android/i.test(userAgent)) {
            return "android";
        }

        // iOS detection from: http://stackoverflow.com/a/9039885/177710
        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
            return "ios";
        }

        return "unknown";
    }

    function setOsDetails() {
        let os = getMobileOperatingSystem();
        console.log(os);
        $("#osDetails").val(os);
    }

    container.on("click", "#qr-img,#qr-zoom", function () {
        let $img = $("#qr-img");
        zoomQrCode($img)
    });

    function zoomQrCode(img) {
        let src = img.attr('src');
        let modal;
        let $body = $('body');

        function removeModal() {
            modal.remove();
            $body.off('keyup.modal-close');
        }

        modal = $('<img>').css({
            background: 'RGBA(0,0,0,.5) url(' + src + ') no-repeat center',
            backgroundSize: 'contain',
            width: '100%',
            height: '100%',
            position: 'fixed',
            zIndex: '10000',
            top: '0', left: '0',
            cursor: 'zoom-out'
        }).addClass('pixelated')
            .click(function () {
                removeModal();
            }).appendTo('body');

        $body.on('keyup.modal-close', function (e) {
            if (e.key === 'Escape') {
                removeModal();
            }
        });
    }
});